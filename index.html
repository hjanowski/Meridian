<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meridian Strategic Command: Unified Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4338ca', // Indigo 700
                        secondary: '#06b6d4', // Cyan 500
                        accent: '#f43f5e', // Rose 500
                        neutral: '#1e293b', // Slate 800
                        background: '#f8fafc', // Slate 50
                        success: '#10b981', // Emerald 500
                    }
                }
            }
        }
    </script>

    <style>
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 380px;
            max-height: 400px;
        }

        .arrow-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .tab-active {
            border-bottom: 4px solid #4338ca;
            color: #4338ca;
            font-weight: 800;
        }

        @media (max-width: 640px) {
            .chart-container {
                height: 320px;
            }
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .hidden-section {
            display: none;
        }

        /* Agent Button Styles - Updated */
        .agent-chat-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #2563eb; /* Blue background */
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            bottom: 24px;
            left: 24px;
            z-index: 50;
            cursor: pointer;
        }

        .agent-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
            background: #1d4ed8; /* Darker blue on hover */
        }

        .sparkle-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .sparkle-icon svg {
            width: 100%;
            height: 100%;
        }

        .agent-avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            position: relative;
        }

        .agent-avatar-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .agent-avatar-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1e293b; /* Dark background for agent look */
        }

        .agent-avatar-icon svg {
            width: 80%;
            height: 80%;
        }

        .online-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            background: #10b981;
            border: 2px solid white;
            border-radius: 50%;
        }

        /* Chart Card Layout */
        .dashboard-card {
            position: relative;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
            padding: 2rem;
            padding-bottom: 5.5rem; /* Space for the agent button */
        }

        .insight-pill {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            background: #f1f5f9;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.05em;
            color: #475569;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Global Chat Overlay (Mock) -->
    <div id="chat-overlay" class="fixed bottom-6 right-6 w-80 bg-white shadow-2xl rounded-2xl border border-indigo-50 z-[100] overflow-hidden hidden transition-all duration-300 transform translate-y-4">
        <div class="bg-primary p-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full border-2 border-white/30 overflow-hidden">
                    <div class="agent-avatar-icon">
                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <!-- Head/Circle -->
                            <circle cx="50" cy="50" r="45" fill="#475569"/>
                            <!-- Agent Sunglasses (dark, professional) -->
                            <rect x="15" y="38" width="28" height="20" rx="3" fill="#0f172a" opacity="0.9"/>
                            <rect x="57" y="38" width="28" height="20" rx="3" fill="#0f172a" opacity="0.9"/>
                            <rect x="43" y="48" width="14" height="3" fill="#0f172a"/>
                            <!-- Professional suit/tie silhouette -->
                            <rect x="35" y="65" width="30" height="25" rx="2" fill="#334155"/>
                            <rect x="47" y="65" width="6" height="25" fill="#1e293b"/>
                        </svg>
                    </div>
                </div>
                <div class="text-white">
                    <p class="text-[10px] font-bold opacity-70 tracking-widest">Meridian Advisor</p>
                    <p class="font-bold text-sm">Agentforce</p>
                </div>
            </div>
            <button onclick="toggleChat(null)" class="text-white opacity-60 hover:opacity-100">✕</button>
        </div>
        <div class="p-5">
            <p class="text-sm text-slate-600 leading-relaxed mb-4" id="chat-text">
                How can I help you analyze this chart?
            </p>
            <div class="flex gap-2">
                <input type="text" placeholder="Type a message..." class="flex-1 text-sm border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/20">
                <button class="bg-primary text-white p-2 rounded-lg">➜</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center gap-2">
                    <span class="text-3xl text-primary font-bold">◍</span>
                    <span class="font-black text-xl text-neutral tracking-tight">Meridian Command</span>
                </div>
                <div class="flex space-x-2 md:space-x-8 h-full">
                    <!-- Navigation removed - single page view -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <header class="bg-neutral text-white py-16">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <h1 id="page-title" class="text-4xl md:text-6xl font-black mb-4 tracking-tighter">Meridian Strategic Command</h1>
            <p id="page-description" class="text-lg text-slate-400 max-w-2xl mx-auto font-medium">
                Unified dashboard for Bayesian MMM insights and optimization strategies.
            </p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-12">

        <!-- Informational Widgets at Top (Side by Side) -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <!-- Organic Baseline vs. Media Lift (Smaller) -->
            <div class="dashboard-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-black">Organic Baseline vs. Media Lift</h2>
                    <span class="insight-pill bg-purple-50 text-purple-700">68% Organic Base</span>
                </div>
                <div class="chart-container !h-[280px]">
                    <canvas id="baselineChart"></canvas>
                </div>
                <button onclick="toggleChat('Baseline Demand')" class="agent-chat-btn">
                    <div class="sparkle-icon">
                        <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L14.09 8.26L20 10L14.09 11.74L12 18L9.91 11.74L4 10L9.91 8.26L12 2Z"/>
                            <path d="M18 4L18.5 5.5L20 6L18.5 6.5L18 8L17.5 6.5L16 6L17.5 5.5L18 4Z"/>
                            <path d="M6 14L6.5 15.5L8 16L6.5 16.5L6 18L5.5 16.5L4 16L5.5 15.5L6 14Z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-white tracking-wider">Let's Chat</p>
                        <p class="text-[10px] text-white/80 font-bold">Agentforce</p>
                    </div>
                </button>
            </div>

            <!-- Certainty Analysis (Smaller) -->
            <div class="dashboard-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-black">Certainty Analysis</h2>
                    <span class="insight-pill bg-slate-100 text-slate-600 border border-slate-200">92% Model Confidence</span>
                </div>
                <div class="chart-container !h-[280px]">
                    <div id="plotlyBayesian" style="width: 100%; height: 100%;"></div>
                </div>
                <button onclick="toggleChat('Bayesian Distributions')" class="agent-chat-btn">
                    <div class="sparkle-icon">
                        <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L14.09 8.26L20 10L14.09 11.74L12 18L9.91 11.74L4 10L9.91 8.26L12 2Z"/>
                            <path d="M18 4L18.5 5.5L20 6L18.5 6.5L18 8L17.5 6.5L16 6L17.5 5.5L18 4Z"/>
                            <path d="M6 14L6.5 15.5L8 16L6.5 16.5L6 18L5.5 16.5L4 16L5.5 15.5L6 14Z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-white tracking-wider">Let's Chat</p>
                        <p class="text-[10px] text-white/80 font-bold">Agentforce</p>
                    </div>
                </button>
            </div>
        </section>

        <!-- Main Dashboard Widgets -->
        <div class="space-y-12">
            
            <!-- Budget Optimization -->
            <section class="dashboard-card">
                <div class="flex justify-between items-start mb-8 gap-4">
                    <div>
                        <h2 class="text-2xl font-black text-neutral tracking-tight">Budget Optimization Scenario</h2>
                        <p class="text-sm text-slate-500 mt-1 font-medium">Recommended vs. Current allocation based on marginal return.</p>
                    </div>
                    <div class="bg-emerald-100 text-emerald-800 px-4 py-2 rounded-full font-black text-xs border border-emerald-200">
                        +12.5% Revenue Lift
                    </div>
                </div>
                <div class="chart-container relative">
                    <canvas id="optimizationChart"></canvas>
                </div>
                
                <!-- Budget Summary (Hidden by default) -->
                <div id="budgetSummary" class="hidden mt-6 p-6 bg-slate-50 rounded-xl border border-slate-200">
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center">
                            <p class="text-sm text-slate-600 font-medium">Total Overspend</p>
                            <p class="text-2xl font-black text-slate-800">$75,000</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-slate-600 font-medium">Total Underspend</p>
                            <p class="text-2xl font-black text-slate-800">$73,000</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-slate-600 font-medium">Spend Surplus</p>
                            <p class="text-2xl font-black text-emerald-600">$2,000</p>
                        </div>
                    </div>
                    <div class="flex gap-4 justify-center">
                        <button class="px-6 py-3 bg-primary text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors">
                            Create New Budget Allocation Plan
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-4 items-center">
                    <button onclick="toggleVisualizeInsights()" class="px-6 py-3 bg-primary text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors">
                        Visualize Insights
                    </button>
                    <button onclick="toggleChat('Optimization Logic')" class="agent-chat-btn">
                    <div class="sparkle-icon">
                        <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L14.09 8.26L20 10L14.09 11.74L12 18L9.91 11.74L4 10L9.91 8.26L12 2Z"/>
                            <path d="M18 4L18.5 5.5L20 6L18.5 6.5L18 8L17.5 6.5L16 6L17.5 5.5L18 4Z"/>
                            <path d="M6 14L6.5 15.5L8 16L6.5 16.5L6 18L5.5 16.5L4 16L5.5 15.5L6 14Z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-white tracking-wider">Let's Chat</p>
                        <p class="text-[10px] text-white/80 font-bold">Agentforce</p>
                    </div>
                </button>
            </section>

            <!-- Saturation Landscape -->
            <section class="dashboard-card">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-black">Saturation Landscape</h2>
                        <p class="text-xs text-slate-500 italic mt-1">Incremental Revenue vs. Absolute Spend.</p>
                    </div>
                    <span class="insight-pill bg-purple-50 text-purple-700">Volume Saturation</span>
                </div>
                <div class="chart-container">
                    <canvas id="saturationLandscapeChart"></canvas>
                </div>
                <button onclick="toggleChat('Saturation Landscape')" class="agent-chat-btn">
                    <div class="sparkle-icon">
                        <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L14.09 8.26L20 10L14.09 11.74L12 18L9.91 11.74L4 10L9.91 8.26L12 2Z"/>
                            <path d="M18 4L18.5 5.5L20 6L18.5 6.5L18 8L17.5 6.5L16 6L17.5 5.5L18 4Z"/>
                            <path d="M6 14L6.5 15.5L8 16L6.5 16.5L6 18L5.5 16.5L4 16L5.5 15.5L6 14Z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-white tracking-wider">Let's Chat</p>
                        <p class="text-[10px] text-white/80 font-bold">Agentforce</p>
                    </div>
                </button>
            </section>

            <!-- Adstock Carryover Effects -->
            <section class="dashboard-card">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-black">Adstock Carryover Effects</h2>
                    <span class="insight-pill bg-blue-50 text-blue-700">12-Week Brand Halo</span>
                </div>
                <div class="chart-container">
                    <canvas id="decayChart"></canvas>
                </div>
                <button onclick="toggleChat('Adstock Decay')" class="agent-chat-btn">
                    <div class="sparkle-icon">
                        <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L14.09 8.26L20 10L14.09 11.74L12 18L9.91 11.74L4 10L9.91 8.26L12 2Z"/>
                            <path d="M18 4L18.5 5.5L20 6L18.5 6.5L18 8L17.5 6.5L16 6L17.5 5.5L18 4Z"/>
                            <path d="M6 14L6.5 15.5L8 16L6.5 16.5L6 18L5.5 16.5L4 16L5.5 15.5L6 14Z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-white tracking-wider">Let's Chat</p>
                        <p class="text-[10px] text-white/80 font-bold">Agentforce</p>
                    </div>
                </button>
            </section>

            <!-- Channel Efficiency -->
            <section class="dashboard-card">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-xl font-black">Channel Efficiency (mROI)</h2>
                    <span class="insight-pill bg-indigo-50 text-indigo-700">Search: 3.8x ROI</span>
                </div>
                <div class="chart-container">
                    <canvas id="roiChart"></canvas>
                </div>
                <button onclick="toggleChat('Marginal Efficiency')" class="agent-chat-btn">
                    <div class="sparkle-icon">
                        <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L14.09 8.26L20 10L14.09 11.74L12 18L9.91 11.74L4 10L9.91 8.26L12 2Z"/>
                            <path d="M18 4L18.5 5.5L20 6L18.5 6.5L18 8L17.5 6.5L16 6L17.5 5.5L18 4Z"/>
                            <path d="M6 14L6.5 15.5L8 16L6.5 16.5L6 18L5.5 16.5L4 16L5.5 15.5L6 14Z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-white tracking-wider">Let's Chat</p>
                        <p class="text-[10px] text-white/80 font-bold">Agentforce</p>
                    </div>
                </button>
            </section>

        </div>

    </main>

    <footer class="bg-neutral text-slate-500 py-16 text-center border-t border-slate-800 mt-12">
        <div class="max-w-7xl mx-auto px-6">
            <p class="text-xs tracking-[0.3em] font-bold">© 2026 Meridian Strategic Unified Command</p>
            <p class="text-[10px] mt-2 opacity-50 tracking-widest">Advanced Bayesian Marketing Mix Modeling System</p>
        </div>
    </footer>

    <script>
        // Tab switching removed - single page view

        function toggleChat(topic) {
            const overlay = document.getElementById('chat-overlay');
            const chatText = document.getElementById('chat-text');
            if(topic) {
                chatText.innerHTML = `Hi! I'm Agentforce. I noticed you're exploring the <strong>${topic}</strong> chart. Would you like me to break down the specific Meridian priors we used for this calculation?`;
                overlay.classList.remove('hidden');
                overlay.classList.remove('translate-y-4');
                overlay.classList.remove('opacity-0');
            } else {
                overlay.classList.add('hidden');
            }
        }

        let optimizationChartInstance = null;
        let insightsVisible = false;

        function toggleVisualizeInsights() {
            const budgetSummary = document.getElementById('budgetSummary');
            insightsVisible = !insightsVisible;
            
            if (insightsVisible) {
                budgetSummary.classList.remove('hidden');
                // Update chart with enhanced visualization
                if (optimizationChartInstance) {
                    // Update data to match image values
                    optimizationChartInstance.data.datasets[0].data = [95, 100, 100, 98, 98]; // Current Spend
                    optimizationChartInstance.data.datasets[1].data = [70, 145, 130, 60, 88]; // Optimized Spend
                    
                    // Remove existing marker datasets if any
                    if (optimizationChartInstance.data.datasets.length > 2) {
                        optimizationChartInstance.data.datasets = optimizationChartInstance.data.datasets.slice(0, 2);
                    }
                    
                    optimizationChartInstance.update('none');
                    
                    // Add change labels, dots, and arrows after chart renders
                    setTimeout(() => {
                        addChangeLabels();
                        addYellowDots();
                        // Draw arrows after dots are positioned
                        setTimeout(() => {
                            drawArrows();
                        }, 100);
                    }, 500);
                }
            } else {
                budgetSummary.classList.add('hidden');
                // Reset to original data
                if (optimizationChartInstance) {
                    optimizationChartInstance.data.datasets[0].data = [100, 100, 100, 100, 100];
                    optimizationChartInstance.data.datasets[1].data = [75, 145, 130, 60, 90];
                    // Remove marker datasets
                    if (optimizationChartInstance.data.datasets.length > 2) {
                        optimizationChartInstance.data.datasets = optimizationChartInstance.data.datasets.slice(0, 2);
                    }
                    optimizationChartInstance.update('none');
                    // Remove change labels, dots, and arrows
                    document.querySelectorAll('.change-label').forEach(el => el.remove());
                    document.querySelectorAll('.yellow-dot').forEach(el => el.remove());
                    document.querySelectorAll('.arrow-overlay').forEach(el => el.remove());
                }
            }
        }

        function addChangeLabels() {
            // Remove existing labels
            document.querySelectorAll('.change-label').forEach(el => el.remove());
            
            const chartContainer = document.getElementById('optimizationChart').parentElement;
            const chart = optimizationChartInstance;
            
            if (!chart) return;
            
            const chartArea = chart.chartArea;
            const currentMeta = chart.getDatasetMeta(0);
            
            const changes = [
                { text: 'Reduce Spend by 25k', direction: 'down' },
                { text: 'Increase Spend by 45k', direction: 'up' },
                { text: 'Increase Spend by 30k', direction: 'up' },
                { text: 'Reduce Spend by 38k', direction: 'down' },
                { text: 'Reduce Spend by 10k', direction: 'down' }
            ];
            
            changes.forEach((change, idx) => {
                if (currentMeta.data[idx]) {
                    const bar = currentMeta.data[idx];
                    const x = bar.x;
                    const y = chartArea.top - 25;
                    
                    const label = document.createElement('div');
                    label.className = 'change-label absolute text-xs font-bold text-slate-700 text-center';
                    label.textContent = change.text;
                    label.style.left = `${x + chartArea.left - 50}px`;
                    label.style.top = `${y}px`;
                    label.style.width = '100px';
                    label.style.zIndex = '15';
                    chartContainer.appendChild(label);
                }
            });
        }

        function drawArrows() {
            // Remove existing arrows
            document.querySelectorAll('.arrow-overlay').forEach(el => el.remove());
            
            const chartContainer = document.getElementById('optimizationChart').parentElement;
            const chart = optimizationChartInstance;
            
            if (!chart) {
                setTimeout(drawArrows, 100);
                return;
            }
            
            const chartArea = chart.chartArea;
            const currentMeta = chart.getDatasetMeta(0);
            const optimizedMeta = chart.getDatasetMeta(1);
            const yScale = chart.scales.y;
            
            if (!currentMeta || !optimizedMeta || !yScale) {
                setTimeout(drawArrows, 100);
                return;
            }
            
            const currentValues = [95, 100, 100, 98, 98];
            const optimizedValues = [70, 145, 130, 60, 88];
            
            // Get canvas dimensions
            const canvas = document.getElementById('optimizationChart');
            const canvasRect = canvas.getBoundingClientRect();
            
            // Create SVG overlay positioned absolutely over the chart area
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.className = 'arrow-overlay';
            svg.style.left = `${chartArea.left}px`;
            svg.style.top = `${chartArea.top}px`;
            svg.style.width = `${chartArea.right - chartArea.left}px`;
            svg.style.height = `${chartArea.bottom - chartArea.top}px`;
            svg.style.zIndex = '11';
            
            svg.setAttribute('width', chartArea.right - chartArea.left);
            svg.setAttribute('height', chartArea.bottom - chartArea.top);
            svg.setAttribute('viewBox', `0 0 ${chartArea.right - chartArea.left} ${chartArea.bottom - chartArea.top}`);
            
            // Add arrowhead marker definition
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead-orange');
            marker.setAttribute('markerWidth', '12');
            marker.setAttribute('markerHeight', '12');
            marker.setAttribute('refX', '10');
            marker.setAttribute('refY', '3');
            marker.setAttribute('orient', 'auto');
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 12 3, 0 6');
            polygon.setAttribute('fill', '#f97316'); // Orange color
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);
            
            // Draw arrows from current dot to optimized dot
            currentMeta.data.forEach((bar, idx) => {
                if (optimizedMeta.data[idx]) {
                    // Get pixel positions relative to chart area
                    const x = bar.x - chartArea.left;
                    const y1 = yScale.getPixelForValue(currentValues[idx]) - chartArea.top;
                    const y2 = yScale.getPixelForValue(optimizedValues[idx]) - chartArea.top;
                    
                    // Draw arrow line with orange color
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', y2);
                    line.setAttribute('stroke', '#f97316'); // Orange color
                    line.setAttribute('stroke-width', '4');
                    line.setAttribute('marker-end', 'url(#arrowhead-orange)');
                    svg.appendChild(line);
                }
            });
            
            chartContainer.appendChild(svg);
        }

        // --- Standard Chart Utils ---
        function wrapLabel(label) {
            if (typeof label !== 'string' || label.length <= 16) return label;
            const words = label.split(' ');
            const lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                if ((currentLine + " " + words[i]).length > 16) {
                    lines.push(currentLine); currentLine = words[i];
                } else {
                    currentLine += " " + words[i];
                }
            }
            lines.push(currentLine); return lines;
        }

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    backgroundColor: '#1e293b',
                    padding: 12,
                    titleFont: { weight: 'bold', size: 14 },
                    callbacks: {
                        title: (tooltipItems) => {
                            const label = tooltipItems[0].chart.data.labels[tooltipItems[0].dataIndex];
                            return Array.isArray(label) ? label.join(' ') : label;
                        }
                    }
                },
                legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold' } } }
            }
        };

        window.onload = function() {
            // 1. Optimization
            optimizationChartInstance = new Chart(document.getElementById('optimizationChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ["Paid Search Ads", "Social Media Ads", "Online Video Ads", "Display Ads", "Linear TV Ads"].map(wrapLabel),
                    datasets: [
                        { label: 'Current Spend', data: [100, 100, 100, 100, 100], backgroundColor: '#e2e8f0', borderRadius: 8 },
                        { label: 'Optimized Spend', data: [75, 145, 130, 60, 90], backgroundColor: '#4338ca', borderRadius: 8 }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        x: {
                            ...commonOptions.scales?.x,
                            stacked: false
                        },
                        y: {
                            ...commonOptions.scales?.y,
                            stacked: false
                        }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: {
                                afterLabel: (context) => {
                                    if (insightsVisible && context.datasetIndex === 1) {
                                        const current = context.chart.data.datasets[0].data[context.dataIndex];
                                        const optimized = context.chart.data.datasets[1].data[context.dataIndex];
                                        const change = optimized - current;
                                        return change > 0 
                                            ? `Increase by $${Math.abs(change)}k`
                                            : `Reduce by $${Math.abs(change)}k`;
                                    }
                                    return '';
                                }
                            }
                        }
                    }
                }
            });

            // 2. ROI (CRITICAL: Populating working data)
            new Chart(document.getElementById('roiChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ["Search", "Social", "Video", "Display", "TV"].map(wrapLabel),
                    datasets: [{
                        label: 'Marginal ROI ($)',
                        data: [3.8, 2.7, 2.1, 1.1, 1.4],
                        backgroundColor: ['#4338ca', '#6366f1', '#f43f5e', '#fb7185', '#06b6d4'],
                        borderRadius: 6
                    }]
                },
                options: {
                    ...commonOptions,
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true, grid: { display: false } } }
                }
            });

            // 3. Saturation Landscape
            // Hill function (MMM standard saturation curve): y = (Vmax * x^n) / (K^n + x^n)
            function hillFunction(x, Vmax, K, n) {
                if (x === 0) return 0;
                return (Vmax * Math.pow(x, n)) / (Math.pow(K, n) + Math.pow(x, n));
            }
            
            function generateSaturationData() {
                // Generate data points for smooth curves
                const spendPoints = [];
                const paidSearchData = [];
                const socialMetaData = [];
                const linearTVData = [];
                
                for (let spend = 0; spend <= 1500; spend += 25) {
                    spendPoints.push(spend);
                    
                    // Paid Search: Classic saturation curve - rapid initial growth, then flattens
                    // Vmax=2400, K=300 (half-saturation at $300k), n=1.5 (moderate steepness)
                    const paidSearch = hillFunction(spend, 2400, 300, 1.5);
                    paidSearchData.push(paidSearch);
                    
                    // Social Meta: Similar saturation but slightly less efficient
                    // Vmax=2300, K=400 (slightly higher half-saturation), n=1.3 (slightly less steep)
                    const socialMeta = hillFunction(spend, 2300, 400, 1.3);
                    socialMetaData.push(socialMeta);
                    
                    // Linear TV: More gradual saturation, higher half-saturation point
                    // Vmax=2300, K=800 (much higher half-saturation), n=1.0 (more linear)
                    const linearTV = hillFunction(spend, 2300, 800, 1.0);
                    linearTVData.push(linearTV);
                }
                
                return { spendPoints, paidSearchData, socialMetaData, linearTVData };
            }
            
            const saturationData = generateSaturationData();
            
            // Calculate point of diminishing returns (where marginal ROI drops significantly)
            // Using 85% of maximum efficiency as the threshold
            function findDiminishingReturnsPoint(dataPoints, spendPoints, Vmax) {
                const threshold = 0.85 * Vmax;
                for (let i = 0; i < dataPoints.length - 1; i++) {
                    // Check if we're past 85% of max and marginal return is dropping
                    if (dataPoints[i] >= threshold) {
                        // Find where marginal return drops below 10% of initial slope
                        const marginalReturn = (dataPoints[i + 1] - dataPoints[i]) / (spendPoints[i + 1] - spendPoints[i]);
                        if (marginalReturn < 0.1) {
                            return i;
                        }
                    }
                }
                // Default to 80% of max spend if no clear threshold
                return Math.floor(dataPoints.length * 0.8);
            }
            
            // Current spend positions (example values - these would come from actual data)
            const currentSpends = {
                paidSearch: 350,
                socialMeta: 280,
                linearTV: 600
            };
            
            // Current monthly spend rates (for time calculation)
            const monthlySpendRates = {
                paidSearch: 50, // $50k/month
                socialMeta: 40, // $40k/month
                linearTV: 80    // $80k/month
            };
            
            // Find diminishing returns points
            const paidSearchDRIdx = findDiminishingReturnsPoint(saturationData.paidSearchData, saturationData.spendPoints, 2400);
            const socialMetaDRIdx = findDiminishingReturnsPoint(saturationData.socialMetaData, saturationData.spendPoints, 2300);
            const linearTVDRIdx = findDiminishingReturnsPoint(saturationData.linearTVData, saturationData.spendPoints, 2300);
            
            const paidSearchDRSpend = saturationData.spendPoints[paidSearchDRIdx];
            const socialMetaDRSpend = saturationData.spendPoints[socialMetaDRIdx];
            const linearTVDRSpend = saturationData.spendPoints[linearTVDRIdx];
            
            // Find current spend indices
            function findClosestIndex(value, array) {
                return array.reduce((prev, curr, idx) => 
                    Math.abs(curr - value) < Math.abs(array[prev] - value) ? idx : prev, 0
                );
            }
            
            const paidSearchCurrentIdx = findClosestIndex(currentSpends.paidSearch, saturationData.spendPoints);
            const socialMetaCurrentIdx = findClosestIndex(currentSpends.socialMeta, saturationData.spendPoints);
            const linearTVCurrentIdx = findClosestIndex(currentSpends.linearTV, saturationData.spendPoints);
            
            // Calculate recommended additional spend and time remaining
            const paidSearchAdditional = Math.max(0, paidSearchDRSpend - currentSpends.paidSearch);
            const socialMetaAdditional = Math.max(0, socialMetaDRSpend - currentSpends.socialMeta);
            const linearTVAdditional = Math.max(0, linearTVDRSpend - currentSpends.linearTV);
            
            const paidSearchMonths = monthlySpendRates.paidSearch > 0 ? Math.ceil(paidSearchAdditional / monthlySpendRates.paidSearch) : 0;
            const socialMetaMonths = monthlySpendRates.socialMeta > 0 ? Math.ceil(socialMetaAdditional / monthlySpendRates.socialMeta) : 0;
            const linearTVMonths = monthlySpendRates.linearTV > 0 ? Math.ceil(linearTVAdditional / monthlySpendRates.linearTV) : 0;
            
            // Create single marker for each curve at current spend position
            const paidSearchMarker = saturationData.paidSearchData.map((val, idx) => 
                idx === paidSearchCurrentIdx ? val : null
            );
            const socialMetaMarker = saturationData.socialMetaData.map((val, idx) => 
                idx === socialMetaCurrentIdx ? val : null
            );
            const linearTVMarker = saturationData.linearTVData.map((val, idx) => 
                idx === linearTVCurrentIdx ? val : null
            );
            
            new Chart(document.getElementById('saturationLandscapeChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: saturationData.spendPoints,
                    datasets: [
                        {
                            label: 'Paid Search',
                            data: saturationData.paidSearchData,
                            borderColor: '#1e40af', // Dark blue
                            backgroundColor: 'transparent',
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'Social Meta',
                            data: saturationData.socialMetaData,
                            borderColor: '#06b6d4', // Cyan/light blue
                            backgroundColor: 'transparent',
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: 'Linear TV',
                            data: saturationData.linearTVData,
                            borderColor: '#dc2626', // Red
                            backgroundColor: 'transparent',
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        // Current position marker for Paid Search
                        {
                            label: 'Paid Search - Current',
                            data: paidSearchMarker,
                            pointRadius: 8,
                            pointBackgroundColor: '#000000',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 10,
                            showLine: false,
                            borderColor: 'transparent',
                            order: 1
                        },
                        // Current position marker for Social Meta
                        {
                            label: 'Social Meta - Current',
                            data: socialMetaMarker,
                            pointRadius: 8,
                            pointBackgroundColor: '#000000',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 10,
                            showLine: false,
                            borderColor: 'transparent',
                            order: 1
                        },
                        // Current position marker for Linear TV
                        {
                            label: 'Linear TV - Current',
                            data: linearTVMarker,
                            pointRadius: 8,
                            pointBackgroundColor: '#000000',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 10,
                            showLine: false,
                            borderColor: 'transparent',
                            order: 1
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Absolute Spend ($000s)',
                                font: { weight: 'bold' }
                            },
                            min: 0,
                            max: 1500,
                            ticks: {
                                stepSize: 200,
                                maxTicksLimit: 8
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Revenue Contribution ($000s)',
                                font: { weight: 'bold' }
                            },
                            beginAtZero: true,
                            max: 2500,
                            ticks: {
                                stepSize: 500,
                                maxTicksLimit: 6
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        legend: {
                            ...commonOptions.plugins.legend,
                            filter: (item) => !item.text.includes('Current') // Hide current position markers from legend
                        },
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            filter: (tooltipItem) => {
                                // Only show tooltips for the marker datasets (indices 3, 4, 5)
                                return tooltipItem.datasetIndex >= 3 && tooltipItem.parsed.y !== null;
                            },
                            callbacks: {
                                title: (tooltipItems) => {
                                    if (tooltipItems.length === 0) return '';
                                    const item = tooltipItems[0];
                                    const datasetIndex = item.datasetIndex;
                                    
                                    if (datasetIndex === 3) {
                                        return 'Paid Search - Current Position';
                                    } else if (datasetIndex === 4) {
                                        return 'Social Meta - Current Position';
                                    } else if (datasetIndex === 5) {
                                        return 'Linear TV - Current Position';
                                    }
                                    return '';
                                },
                                label: (tooltipItem) => {
                                    const datasetIndex = tooltipItem.datasetIndex;
                                    let currentSpend, additionalSpend, monthsRemaining;
                                    
                                    if (datasetIndex === 3) {
                                        currentSpend = currentSpends.paidSearch;
                                        additionalSpend = paidSearchAdditional;
                                        monthsRemaining = paidSearchMonths;
                                    } else if (datasetIndex === 4) {
                                        currentSpend = currentSpends.socialMeta;
                                        additionalSpend = socialMetaAdditional;
                                        monthsRemaining = socialMetaMonths;
                                    } else if (datasetIndex === 5) {
                                        currentSpend = currentSpends.linearTV;
                                        additionalSpend = linearTVAdditional;
                                        monthsRemaining = linearTVMonths;
                                    } else {
                                        return '';
                                    }
                                    
                                    return [
                                        `Current Spend: $${currentSpend.toFixed(0)}k`,
                                        `Recommended Additional: $${additionalSpend.toFixed(0)}k`,
                                        `Time Until Diminishing Returns: ${monthsRemaining} months`
                                    ];
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: true,
                        mode: 'point'
                    }
                }
            });

            // 4. Bayesian
            function getDensity(m, s) {
                let x = [], y = [];
                for(let i = m-4*s; i <= m+4*s; i += s/10) {
                    x.push(i);
                    y.push(Math.exp(-0.5*Math.pow((i-m)/s, 2))/(s*Math.sqrt(2*Math.PI)));
                }
                return {x, y};
            }
            const dist = getDensity(1.4, 0.18);
            Plotly.newPlot('plotlyBayesian', [{
                x: dist.x, y: dist.y, type: 'scatter', fill: 'tozeroy', mode: 'lines',
                line: {color: '#4338ca', width: 3}
            }], {
                margin: {t: 20, r: 20, l: 40, b: 40},
                xaxis: {title: 'Sales Coefficient (Impact)', fixedrange: true},
                yaxis: {showticklabels: false, fixedrange: true},
                plot_bgcolor: "rgba(0,0,0,0)",
                paper_bgcolor: "rgba(0,0,0,0)"
            }, {responsive: true, displayModeBar: false});

            // 5. Decay
            new Chart(document.getElementById('decayChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ["Wk 1", "Wk 2", "Wk 3", "Wk 4", "Wk 5", "Wk 6", "Wk 7", "Wk 8"],
                    datasets: [
                        { label: 'Linear TV', data: [100, 88, 78, 70, 63, 58, 54, 50], borderColor: '#4338ca', borderWidth: 3 },
                        { label: 'Social Media', data: [100, 35, 12, 4, 1, 0, 0, 0], borderColor: '#f43f5e', borderWidth: 3 }
                    ]
                },
                options: commonOptions
            });

            // 6. Baseline
            new Chart(document.getElementById('baselineChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    datasets: [
                        { label: wrapLabel('Organic Baseline'), data: [400, 415, 430, 425, 410, 440, 460, 470, 465, 490, 530, 590], fill: true, backgroundColor: '#f1f5f9', pointRadius: 0 },
                        { label: wrapLabel('Media Lift'), data: [70, 85, 110, 100, 95, 120, 145, 155, 140, 180, 220, 310], fill: true, backgroundColor: 'rgba(67, 56, 202, 0.8)', pointRadius: 0 }
                    ]
                },
                options: { ...commonOptions, scales: { y: { stacked: true } } }
            });

            // Saturation Curves widget removed
        };
    </script>
</body>
</html>

